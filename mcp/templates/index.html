<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contextual Advertising Agent</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/databricks-symbol-color.svg">
    <link rel="shortcut icon" href="/static/images/databricks-symbol-color.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .main-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .content-container {
            display: flex;
            flex: 1;
            min-height: calc(100vh - 120px);
        }
        
        .about-panel {
            width: 0;
            background: #f8f9fa;
            border-right: 1px solid #e1e5e9;
            overflow: hidden;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        
        .about-panel.open {
            width: 300px;
        }
        
        .hamburger-menu {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            transition: all 0.3s ease;
        }
        
        .hamburger-menu:hover {
            opacity: 0.8;
        }
        
        .hamburger-menu img {
            transition: all 0.3s ease;
        }
        
        .about-panel-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .about-panel-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            font-size: 15px;
            line-height: 1.6;
        }
        
        .about-panel-content h3 {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 16px;
        }
        
        .about-panel-content h4 {
            color: #34495e;
            margin: 20px 0 10px 0;
            font-size: 15px;
        }
        
        .about-panel-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .about-panel-content li {
            margin: 8px 0;
            color: #555;
        }
        
        .about-panel-content p {
            margin: 15px 0;
            color: #555;
        }
        
        .collapsible-section {
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .collapsible-header {
            background: #c2c5c8;
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #c2c5c8;
            transition: background-color 0.2s ease;
        }
        
        .collapsible-header:hover {
            background: #a4a6aa;
        }
        
        .collapsible-header h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 15px;
            font-weight: 600;
        }
        
        .collapsible-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.2s ease;
        }
        
        .collapsible-section.open .collapsible-icon {
            transform: rotate(90deg);
        }
        
        .collapsible-content {
            padding: 15px;
            display: none;
        }
        
        .collapsible-section.open .collapsible-content {
            display: block;
        }
        
        .health-check-section .button {
            font-size: 12px;
            padding: 8px 16px;
        }
        
        /* Tab styling */
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 20px;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: #FF3621;
            border-bottom-color: #FF3621;
        }
        
        .tab-button:hover {
            color: #FF3621;
            background: #f8f9fa;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Image upload styling */
        .image-upload-area {
            border: 2px dashed #e1e5e9;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .image-upload-area:hover {
            border-color: #FF3621;
            background: #fff5f5;
        }
        
        .image-upload-area.dragover {
            border-color: #FF3621;
            background: #fff5f5;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #6c757d;
            margin-bottom: 16px;
        }
        
        .upload-text {
            font-size: 17px;
            color: #555;
            margin-bottom: 8px;
        }
        
        .upload-subtext {
            font-size: 15px;
            color: #999;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            margin: 0 auto;
            display: block;
        }
        
        .image-preview-container {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .image-preview-container.show {
            display: block;
        }
        
        .image-preview-container .button {
            width: auto;
            min-width: 150px;
            margin: 0 5px;
            display: inline-block;
        }
        
        .tab-content .button:not(.image-preview-container .button) {
            width: auto;
            min-width: 200px;
            margin: 0 auto;
            display: block;
        }
        
        .tab-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .clear-recommendation-btn {
            background: #c2c5c8 !important;
            color: #333 !important;
            font-size: 12px !important;
            padding: 6px 12px !important;
            margin: 0 !important;
            min-width: auto !important;
            width: auto !important;
            display: inline-block !important;
        }
        
        .upload-widget {
            display: block;
        }
        
        .upload-widget.hidden {
            display: none;
        }
        
        .file-input {
            display: none;
        }
        
        .chat-panel {
            flex: 1;
            background: white;
            border-right: 1px solid #e1e5e9;
            display: flex;
            flex-direction: column;
        }
        
        .chain-of-thought-panel {
            flex: 0 0 33.333%;
            background: #f8f9fa;
            border-left: 1px solid #e1e5e9;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-left {
            display: flex;
            align-items: center;
        }
        
        .databricks-logo {
            width: 32px;
            height: 32px;
            margin-right: 12px;
        }
        
        .header h1 {
            font-size: 1.8em;
            margin: 0;
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chat-content {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
        }
        
        .chain-of-thought-content-panel {
            padding: 0;
            flex: 1;
            overflow-y: auto;
        }
        
        .chain-of-thought-header {
            background: #96a3f4;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        textarea:focus {
            outline: none;
            border-color: #FF3621;
        }
        
        .button {
            background: #FF3621;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
        }
        
        .button:hover {
            transform: translateY(-2px);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .response {
            margin-top: 30px;
            padding: 20px;
            background: #ffffff;
            border-radius: 8px;
            border-left: 4px solid #FF3621;
            display: none;
        }
        
        .response h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .response-content {
            line-height: 1.6;
            color: #555;
        }
        
        /* Markdown styling */
        .response-content h1,
        .response-content h2,
        .response-content h3,
        .response-content h4,
        .response-content h5,
        .response-content h6 {
            margin: 20px 0 10px 0;
            color: #333;
            font-weight: 600;
        }
        
        .response-content h1 { font-size: 1.8em; }
        .response-content h2 { font-size: 1.5em; }
        .response-content h3 { font-size: 1.3em; }
        .response-content h4 { font-size: 1.1em; }
        
        .response-content p {
            margin: 10px 0;
        }
        
        .response-content ul,
        .response-content ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .response-content li {
            margin: 5px 0;
        }
        
        .response-content strong {
            font-weight: 600;
            color: #333;
        }
        
        .response-content em {
            font-style: italic;
        }
        
        .response-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9em;
        }
        
        .response-content pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .response-content pre code {
            background: none;
            padding: 0;
        }
        
        .response-content blockquote {
            border-left: 4px solid #FF3621;
            margin: 15px 0;
            padding-left: 15px;
            color: #666;
            font-style: italic;
        }
        
        .response-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .response-content th,
        .response-content td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        
        .response-content th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        /* Chain of thought styling */
        .chain-of-thought-content {
            font-family: 'DM Sans', sans-serif;
            font-size: 15px;
            line-height: 1.5;
            color: #555;
            border-left: none;
            padding-left: 0;
            margin-left: 0;
        }
        
        .chain-of-thought-placeholder {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px 20px;
        }
        
        .chain-of-thought-content h1,
        .chain-of-thought-content h2,
        .chain-of-thought-content h3 {
            font-family: 'DM Sans', sans-serif;
            margin: 10px 0 5px 0;
            color: #333;
        }
        
        .chain-of-thought-content strong {
            color: #FF3621;
            font-weight: 600;
        }
        
        /* Chain of thought specific formatting */
        .cot-user-query {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px 16px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: 600;
            color: #1565c0;
        }
        
        .cot-tool-call {
            background: #fff3e0;
            border: 1px solid #ffb74d;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
        }
        
        .cot-tool-call-header {
            background: #ff9800;
            color: white;
            padding: 6px 12px;
            margin: -12px -12px 8px -12px;
            border-radius: 6px 6px 0 0;
            font-weight: 600;
            font-size: 13px;
        }
        
        .cot-tool-result {
            background: #f3e5f5;
            border: 1px solid #ba68c8;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
        }
        
        .cot-tool-result-header {
            background: #9c27b0;
            color: white;
            padding: 6px 12px;
            margin: -12px -12px 8px -12px;
            border-radius: 6px 6px 0 0;
            font-weight: 600;
            font-size: 13px;
        }
        
        .cot-reasoning {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 12px 16px;
            margin: 10px 0;
            border-radius: 4px;
            font-style: italic;
            color: #2e7d32;
        }
        
        .cot-json-content {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            margin: 4px 0;
            overflow-x: auto;
            white-space: pre-wrap;
            font-size: 13px;
            font-family: 'DM Sans', sans-serif;
        }
        
        .cot-image-description {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 6px;
            margin: 8px 0;
            padding: 10px;
        }
        
        .cot-image-description-header {
            font-weight: bold;
            color: #2e7d32;
            font-size: 13px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
        }
        
        .cot-image-description-content {
            color: #2e7d32;
            font-size: 13px;
            line-height: 1.4;
            font-style: italic;
        }
        
        .cot-prompt-sent {
            background: #fff3e0;
            border: 1px solid #ffcc80;
            border-radius: 6px;
            margin: 8px 0;
            padding: 10px;
        }
        
        .cot-prompt-sent-header {
            font-weight: bold;
            color: #ef6c00;
            font-size: 13px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
        }
        
        .cot-prompt-sent-content {
            color: #ef6c00;
            font-size: 13px;
            line-height: 1.4;
            font-family: 'DM Sans', sans-serif;
        }
        
        .cot-query-content {
            background: #e3f2fd;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 13px;
            color: #1565c0;
        }
        
        .cot-csv-results {
            margin: 0;
        }
        
        .cot-csv-results .cot-scene-item:first-child {
            margin-top: 0;
        }
        
        .cot-scene-item {
            margin: 0 0 8px 0;
            padding: 8px 12px;
            background: #f8fff8;
            border-radius: 4px;
            border-left: 4px solid #4caf50;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .cot-scene-item:hover {
            background: #e8f5e8;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .cot-scene-title {
            font-weight: 600;
            color: #2e7d32;
            font-size: 14px;
            margin-bottom: 6px;
        }
        
        .cot-scene-content {
            color: #555;
            font-size: 13px;
            line-height: 1.4;
            font-style: italic;
        }
        
        .cot-csv-error {
            background: #ffebee;
            color: #c62828;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 13px;
            font-weight: 500;
        }
        
        .cot-csv-raw {
            background: #f5f5f5;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 12px;
            font-family: 'DM Sans', sans-serif;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Scene Modal Styles */
        .scene-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .scene-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .scene-modal-header {
            background: #4caf50;
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .scene-modal-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .scene-modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        
        .scene-modal-close:hover {
            opacity: 0.7;
        }
        
        .scene-modal-body {
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #FF3621;
            display: none;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #FF3621;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #fee;
            border-left-color: #e74c3c;
            color: #c0392b;
        }
        
        .health-status {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .health-status.unhealthy {
            background: #fee;
            border-color: #e74c3c;
            color: #c0392b;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <div class="header-left">
                <button class="hamburger-menu" id="hamburgerMenu" title="Toggle Sidebar">
                    <img src="/static/images/more.png" alt="Menu" style="width: 24px; height: 24px;">
                </button>
                <img src="/static/images/databricks-symbol-color.svg" alt="Databricks" class="databricks-logo">
                <h1>Contextual Content Placement</h1>
            </div>
            <div class="header-right">
                <a href="https://e2-demo-west.cloud.databricks.com/ml/experiments/61a7879438f44eb397dec01dd769b1b5/traces?o=2556758628403379" target="_blank" class="button" id="tracesBtn" style="background: #e74c3c; padding: 8px 16px; font-size: 14px; width: auto; margin: 0; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
                    View Traces & Evals
                    <img src="/static/images/arrow.png" alt="External link" style="width: 12px; height: 12px;">
                </a>
            </div>
        </div>
        
        <div class="content-container">
            <div class="about-panel" id="aboutPanel">
                <div class="about-panel-content">
                    <div class="collapsible-section open" id="aboutSection">
                        <div class="collapsible-header" onclick="toggleSection('aboutSection')">
                            <h4>About this App</h4>
                            <img src="/static/images/right-arrow.png" alt="Expand" class="collapsible-icon">
                        </div>
                        <div class="collapsible-content">
                            <h3>Custom MCP Server on Databricks</h3>
                            <p>This app hosts a custom MCP server that is a wrapper around the contextual content placement agent built and served on Databricks. This means you can not only use the app to test the functionality of the agent to see how it recommends optimal content placement, but you can also leverage the functionality outside of Databricks via the MCP wrapper.</p>
                            
                            <h4>How it works:</h4>
                            <ul>
                                <li>Enter your advertisement or content details and target audience</li>
                                <li>The agent searches through movie scripts for relevant scenes</li>
                                <li>View the reasoning process in the right panel</li>
                                <li>Get detailed recommendations with markdown formatting</li>
                            </ul>
                            
                            <p>For more information, visit <a href="https://docs.databricks.com/aws/en/generative-ai/mcp/custom-mcp" target="_blank" style="color: #FF3621; text-decoration: none;">Custom MCP Servers on Databricks</a>.</p>
                        </div>
                    </div>
                    
                    <div class="collapsible-section" id="connectionSection">
                        <div class="collapsible-header" onclick="toggleSection('connectionSection')">
                            <h4>Connection Status</h4>
                            <img src="/static/images/right-arrow.png" alt="Expand" class="collapsible-icon">
                        </div>
                        <div class="collapsible-content">
                            <button type="button" class="button" id="healthCheckBtn" style="background: #FF3621; padding: 8px 16px; font-size: 14px; width: 100%; margin: 10px 0;">
                                Check Connection Status
                            </button>
                            <div id="healthStatus" class="health-status" style="display: none; margin-top: 10px;">
                                <strong>Click the button above to check connection status</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-panel">
                <div class="chat-content">
                    <div class="tab-container">
                        <div class="tab-buttons">
                            <button class="tab-button active" onclick="switchTab('textTab')">Text Input</button>
                            <button class="tab-button" onclick="switchTab('imageTab')">Image Input</button>
                        </div>
                        
                        <div id="textTab" class="tab-content active">
                            <div class="tab-header">
                                <button type="button" class="button clear-recommendation-btn" id="clearTextBtn">
                                    Clear Recommendation
                                </button>
                            </div>
                            <form id="queryForm">
                                <div class="form-group">
                                    <label for="prompt">Describe your advertisement or content and target audience:</label>
                                    <textarea 
                                        id="prompt" 
                                        name="prompt" 
                                        placeholder="Example: I want to place an advertisement for a new sports drink during a basketball-themed comedy movie. The target audience is young adults aged 18-35 who are interested in fitness and sports."
                                        required
                                    ></textarea>
                                </div>
                                
                                <button type="submit" class="button" id="submitBtn">
                                    Get Content Placement Recommendation
                                </button>
                            </form>
                        </div>
                        
                        <div id="imageTab" class="tab-content">
                            <div class="tab-header">
                                <button type="button" class="button clear-recommendation-btn" id="clearImageRecommendationBtn">
                                    Clear Recommendation
                                </button>
                            </div>
                            <div class="form-group">
                                <label>Upload an image for content placement analysis:</label>
                                
                                <div class="upload-widget" id="uploadWidget">
                                    <div class="image-upload-area" onclick="document.getElementById('imageFile').click()">
                                        <div class="upload-icon">📷</div>
                                        <div class="upload-text">Click to upload or drag and drop</div>
                                        <div class="upload-subtext">PNG, JPG, GIF up to 10MB</div>
                                        <input type="file" id="imageFile" class="file-input" accept="image/*" onchange="handleImageUpload(event)">
                                    </div>
                                </div>
                                
                                <div class="image-preview-container" id="imagePreviewContainer">
                                    <img id="imagePreview" class="image-preview" alt="Image preview">
                                    
                                    <div class="target-audience-section" style="margin-top: 15px; text-align: left;">
                                        <label for="targetAudience" class="input-label" style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">Target Audience (Optional)</label>
                                        <textarea 
                                            id="targetAudience" 
                                            class="input-field" 
                                            placeholder="Describe your target audience (e.g., age, interests, demographics, behavior patterns)..."
                                            rows="3"
                                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; resize: vertical;"
                                        ></textarea>
                                    </div>
                                    
                                    <div style="margin-top: 15px;">
                                        <button type="button" class="button" id="changeImageBtn" style="background: #c2c5c8; margin-right: 10px;">
                                            Change Image
                                        </button>
                                        <button type="button" class="button" id="clearImageBtn" style="background: #c2c5c8; margin-right: 10px;">
                                            Clear
                                        </button>
                                        <button type="button" class="button" id="analyzeImageBtn">
                                            Get Content Placement Recommendation
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Analyzing movie scripts and generating recommendations...</p>
                    </div>
                    
                    <div class="response" id="response">
                        <h3>🎯 Content Placement Recommendation</h3>
                        <div class="response-content" id="responseContent"></div>
                    </div>
                </div>
            </div>
            
            <div class="chain-of-thought-panel">
                <div class="chain-of-thought-header">
                    🧠 Agent Reasoning
                </div>
                <div class="chain-of-thought-content-panel">
                    <div class="chain-of-thought-placeholder" id="chainOfThoughtPlaceholder">
                        Submit a query to see the agent's reasoning process
                    </div>
                    <div class="chain-of-thought-content" id="chainOfThoughtContent" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scene Modal -->
    <div id="sceneModal" class="scene-modal">
        <div class="scene-modal-content">
            <div class="scene-modal-header">
                <h3 class="scene-modal-title" id="modalTitle"></h3>
                <span class="scene-modal-close" onclick="closeSceneModal()">&times;</span>
            </div>
            <div class="scene-modal-body" id="modalContent"></div>
        </div>
    </div>

    <script>
        // Health check functionality
        document.getElementById('healthCheckBtn').addEventListener('click', async () => {
            await checkHealth();
        });
        
        // Hamburger menu functionality
        document.getElementById('hamburgerMenu').addEventListener('click', () => {
            const aboutPanel = document.getElementById('aboutPanel');
            const hamburgerMenu = document.getElementById('hamburgerMenu');
            
            aboutPanel.classList.toggle('open');
            hamburgerMenu.classList.toggle('open');
        });
        
        // Traces button now opens external link directly
        
        // Collapsible sections functionality
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('open');
        }
        
        // Tab functionality
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Show/hide appropriate clear button
            const clearTextBtn = document.getElementById('clearTextBtn');
            const clearImageBtn = document.getElementById('clearImageRecommendationBtn');
            
            if (tabId === 'textTab') {
                clearTextBtn.style.display = 'inline-block';
                clearImageBtn.style.display = 'none';
            } else if (tabId === 'imageTab') {
                clearTextBtn.style.display = 'none';
                clearImageBtn.style.display = 'inline-block';
            }
            
            // Clear recommendation content when switching tabs
            clearRecommendation();
        }
        
        // Image upload functionality
        function handleImageUpload(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('imagePreview');
            const uploadWidget = document.getElementById('uploadWidget');
            const previewContainer = document.getElementById('imagePreviewContainer');
            
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select a valid image file.');
                    return;
                }
                
                // Validate file size (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB.');
                    return;
                }
                
                // Show preview and hide upload widget
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    uploadWidget.classList.add('hidden');
                    previewContainer.classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        }
        
        // Change image functionality
        function changeImage() {
            document.getElementById('imageFile').click();
        }
        
        // Clear image functionality
        function clearImage() {
            const uploadWidget = document.getElementById('uploadWidget');
            const previewContainer = document.getElementById('imagePreviewContainer');
            const imageFile = document.getElementById('imageFile');
            const imagePreview = document.getElementById('imagePreview');
            const targetAudience = document.getElementById('targetAudience');
            
            // Reset file input
            imageFile.value = '';
            
            // Clear target audience
            targetAudience.value = '';
            
            // Hide preview and show upload widget
            previewContainer.classList.remove('show');
            uploadWidget.classList.remove('hidden');
            
            // Clear image source
            imagePreview.src = '';
        }
        
        // Clear recommendation functionality
        function clearRecommendation() {
            const response = document.getElementById('response');
            const responseContent = document.getElementById('responseContent');
            const chainOfThoughtContent = document.getElementById('chainOfThoughtContent');
            const chainOfThoughtPlaceholder = document.getElementById('chainOfThoughtPlaceholder');
            
            // Hide response
            response.style.display = 'none';
            responseContent.innerHTML = '';
            
            // Reset chain of thought
            chainOfThoughtContent.style.display = 'none';
            chainOfThoughtPlaceholder.style.display = 'block';
            chainOfThoughtContent.innerHTML = '';
        }
        
        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.querySelector('.image-upload-area');
            
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('imageFile').files = files;
                    handleImageUpload({ target: { files: files } });
                }
            });
            
            // Change image button event listener
            document.getElementById('changeImageBtn').addEventListener('click', changeImage);
            
            // Clear image button event listener
            document.getElementById('clearImageBtn').addEventListener('click', clearImage);
            
            // Clear recommendation button event listeners
            document.getElementById('clearTextBtn').addEventListener('click', clearRecommendation);
            document.getElementById('clearImageRecommendationBtn').addEventListener('click', clearRecommendation);
        });
        
        // Chain of thought is now always visible in the right panel
        
        // Scene Modal Functions
        function showSceneModal(title, sceneNumber, content) {
            const modal = document.getElementById('sceneModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            modalTitle.textContent = `🎬 ${title} - Scene ${sceneNumber}`;
            modalContent.textContent = content;
            
            modal.style.display = 'block';
        }
        
        function closeSceneModal() {
            const modal = document.getElementById('sceneModal');
            modal.style.display = 'none';
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('sceneModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // Add event delegation for scene items (handles dynamically added content)
        document.addEventListener('click', function(event) {
            if (event.target.closest('.cot-scene-item')) {
                const sceneItem = event.target.closest('.cot-scene-item');
                const title = sceneItem.getAttribute('data-title');
                const sceneNumber = sceneItem.getAttribute('data-scene-number');
                const content = sceneItem.getAttribute('data-full-content');
                
                showSceneModal(title, sceneNumber, content);
            }
        });
        
        // Function to format chain of thought content
        function formatChainOfThought(content) {
            if (!content) return '';
            
            let formatted = content;
            
            // Format user queries (lines that don't start with < or are empty) - DISABLED
            // formatted = formatted.replace(/^([^<\n].+)$/gm, '<div class="cot-user-query">$1</div>');
            
            // Format tool calls
            formatted = formatted.replace(/<tool_call>([\s\S]*?)<\/tool_call>/g, (match, jsonContent) => {
                try {
                    const parsed = JSON.parse(jsonContent.trim());
                    const formattedJson = JSON.stringify(parsed, null, 2);
                    return `<div class="cot-tool-call">
                        <div class="cot-tool-call-header">🔧 Tool Call: ${parsed.name || 'Unknown'}</div>
                        <div class="cot-json-content">${formattedJson}</div>
                    </div>`;
                } catch (e) {
                    return `<div class="cot-tool-call">
                        <div class="cot-tool-call-header">🔧 Tool Call</div>
                        <div class="cot-json-content">${jsonContent}</div>
                    </div>`;
                }
            });
            
            // Format tool call results
            formatted = formatted.replace(/<tool_call_result>([\s\S]*?)<\/tool_call_result>/g, (match, jsonContent) => {
                try {
                    const parsed = JSON.parse(jsonContent.trim());
                    const formattedJson = JSON.stringify(parsed, null, 2);
                    return `<div class="cot-tool-result">
                        <div class="cot-tool-result-header">📋 Tool Result</div>
                        <div class="cot-json-content">${formattedJson}</div>
                    </div>`;
                } catch (e) {
                    return `<div class="cot-tool-result">
                        <div class="cot-tool-result-header">📋 Tool Result</div>
                        <div class="cot-json-content">${jsonContent}</div>
                    </div>`;
                }
            });
            
            // Format reasoning text (lines that start with common reasoning words)
            formatted = formatted.replace(/^(Based on|Let me|I can|I will|The analysis|This shows|Therefore|In conclusion|The results|The data)([\s\S]*?)(?=<|$)/gm, '<div class="cot-reasoning">$1$2</div>');
            
            return formatted;
        }
        
        // Function to format streaming reasoning
        function formatStreamingReasoning(eventData) {
            const subtype = eventData.subtype;
            const data = eventData.data;
            
            if (subtype === 'function_call') {
                const name = data.name || 'Unknown';
                let argumentsHtml = '';
                
                try {
                    const args = JSON.parse(data.arguments || '{}');
                    if (args.query) {
                        argumentsHtml = `<div class='cot-query-content'><strong>Search Query:</strong> ${args.query}</div>`;
                    } else {
                        argumentsHtml = `<div class='cot-json-content'>${data.arguments || ''}</div>`;
                    }
                } catch (e) {
                    argumentsHtml = `<div class='cot-json-content'>${data.arguments || ''}</div>`;
                }
                
                return `<div class='cot-tool-call'>
                    <div class='cot-tool-call-header'>🔧 Tool Call: ${name}</div>
                    ${argumentsHtml}
                </div>`;
            } else if (subtype === 'function_call_output') {
                let outputHtml = '';
                
                try {
                    const outputData = JSON.parse(data.output || '{}');
                    if (outputData.value && outputData.format === 'CSV') {
                        outputHtml = formatCsvResults(outputData.value);
                    } else {
                        outputHtml = `<div class='cot-json-content'>${data.output || ''}</div>`;
                    }
                } catch (e) {
                    outputHtml = `<div class='cot-json-content'>${data.output || ''}</div>`;
                }
                
                return `<div class='cot-tool-result'>
                    <div class='cot-tool-result-header'>📋 Tool Result</div>
                    ${outputHtml}
                </div>`;
            }
            
            return '';
        }
        
        // Function to format CSV results (matches backend formatting)
        function formatCsvResults(csvContent) {
            let html = "<div class='cot-csv-results'>\n";
            
            try {
                // More robust CSV parsing that handles multiline quoted fields
                // CSV format: "page_content","metadata"
                // Both fields are quoted and may contain escaped quotes and newlines
                
                // Use a regex that can match across newlines
                const rowRegex = /"((?:[^"\\]|\\.)*)","((?:[^"\\]|\\.)*)"/g;
                let match;
                let rowCount = 0;
                
                while ((match = rowRegex.exec(csvContent)) !== null) {
                    rowCount++;
                    // Skip header row
                    if (rowCount === 1 && match[1] === 'page_content') {
                        continue;
                    }
                    
                    const pageContent = match[1];
                    const metadataStr = match[2];
                    
                    if (!pageContent || !metadataStr) continue;
                    
                    try {
                        // Parse metadata - convert Python dict format to JSON
                        // Handle incomplete metadata gracefully
                        let jsonStr = metadataStr
                            .replace(/'/g, '"')  // Single to double quotes
                            .replace(/\bNone\b/g, 'null')  // Python None to JSON null
                            .replace(/\bTrue\b/g, 'true')  // Python True to JSON true
                            .replace(/\bFalse\b/g, 'false');  // Python False to JSON false
                        
                        // Check if metadata looks complete
                        if (!jsonStr.includes('{') || !jsonStr.includes('}')) {
                            console.warn('Incomplete metadata detected, skipping:', metadataStr.substring(0, 50));
                            continue;
                        }
                        
                        const metadata = JSON.parse(jsonStr);
                        const title = metadata.title || 'Unknown Title';
                        const sceneNumber = metadata.scene_number || 'Unknown Scene';
                        
                        const displayContent = pageContent.length > 200 
                            ? pageContent.substring(0, 200) + '...' 
                            : pageContent;
                        
                        // Properly escape for HTML attribute
                        const escapedFullContent = pageContent
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#39;');
                        
                        const escapedTitle = String(title).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        const escapedSceneNumber = String(sceneNumber).replace(/"/g, '&quot;');
                        const escapedDisplayContent = displayContent.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        
                        html += `<div class='cot-scene-item' data-title="${escapedTitle}" data-scene-number="${escapedSceneNumber}" data-full-content="${escapedFullContent}">
                            <div class='cot-scene-title'>🎬 ${escapedTitle} - Scene ${escapedSceneNumber}</div>
                            <div class='cot-scene-content'>${escapedDisplayContent}</div>
                        </div>`;
                    } catch (e) {
                        console.error('Error parsing metadata:', e, 'Raw:', metadataStr.substring(0, 100));
                        // Still try to show something if we have valid content
                        if (pageContent && pageContent.length > 10) {
                            const displayContent = pageContent.length > 200 
                                ? pageContent.substring(0, 200) + '...' 
                                : pageContent;
                            const escapedDisplayContent = displayContent.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            html += `<div class='cot-scene-item'>
                                <div class='cot-scene-title'>🎬 Scene (metadata parse error)</div>
                                <div class='cot-scene-content'>${escapedDisplayContent}</div>
                            </div>`;
                        }
                    }
                }
                
                // If no rows were parsed, show an error
                if (rowCount <= 1) {
                    console.error('No valid CSV rows found');
                    html += `<div class='cot-csv-error'>No scenes found in results</div>`;
                }
                
            } catch (e) {
                console.error('Error parsing CSV results:', e);
                html += `<div class='cot-csv-error'>Error parsing results: ${e.message}</div>`;
            }
            
            html += "</div>\n";
            return html;
        }
        
        // Function to handle streaming query
        async function handleStreamingQuery(prompt, isImageQuery = false, imageDescription = null) {
            console.log('[STREAM] Starting streaming query', { isImageQuery, promptLength: prompt?.length });
            
            const submitBtn = document.getElementById('submitBtn');
            const analyzeBtn = document.getElementById('analyzeImageBtn');
            const loading = document.getElementById('loading');
            const response = document.getElementById('response');
            const responseContent = document.getElementById('responseContent');
            const chainOfThoughtContent = document.getElementById('chainOfThoughtContent');
            const chainOfThoughtPlaceholder = document.getElementById('chainOfThoughtPlaceholder');
            
            // Show loading state
            if (isImageQuery) {
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'Analyzing Image...';
            } else {
                submitBtn.disabled = true;
            }
            loading.style.display = 'block';
            response.style.display = 'none';
            chainOfThoughtContent.style.display = 'none';
            chainOfThoughtContent.innerHTML = '';
            chainOfThoughtPlaceholder.style.display = 'block';
            
            // Prepare accumulated data
            let accumulatedText = '';
            let reasoningHtml = '';
            
            try {
                const endpoint = isImageQuery ? '/stream-image' : '/stream-query';
                const body = isImageQuery 
                    ? { 
                        image_data: prompt,
                        target_audience: document.getElementById('targetAudience')?.value || ''
                      }
                    : { prompt: prompt };
                
                console.log('[STREAM] Fetching from endpoint:', endpoint);
                
                const fetchResponse = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });
                
                console.log('[STREAM] Response status:', fetchResponse.status);
                console.log('[STREAM] Response headers:', Object.fromEntries(fetchResponse.headers.entries()));
                
                if (!fetchResponse.ok) {
                    throw new Error(`HTTP ${fetchResponse.status}: ${fetchResponse.statusText}`);
                }
                
                const reader = fetchResponse.body.getReader();
                const decoder = new TextDecoder();
                let chunkCount = 0;
                let buffer = ''; // Buffer for incomplete SSE messages
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        console.log('[STREAM] Stream completed, total chunks:', chunkCount);
                        break;
                    }
                    
                    chunkCount++;
                    // Decode chunk and add to buffer
                    buffer += decoder.decode(value, { stream: true });
                    console.log('[STREAM] Received chunk #' + chunkCount + ', buffer size:', buffer.length);
                    
                    // Split by double newline (SSE message separator)
                    const messages = buffer.split('\n\n');
                    
                    // Keep the last incomplete message in buffer
                    buffer = messages.pop() || '';
                    
                    // Process complete messages
                    for (const message of messages) {
                        if (!message.trim()) continue;
                        
                        const lines = message.split('\n');
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const jsonData = line.substring(6);
                                    const data = JSON.parse(jsonData);
                                    console.log('[STREAM] Parsed event:', data.type);
                                    
                                    if (data.type === 'prompt') {
                                        // Add prompt to reasoning panel
                                        reasoningHtml = `<div class='cot-prompt-sent'><div class='cot-prompt-sent-header'>📝 Prompt sent to agent</div><div class='cot-prompt-sent-content'>${data.content}</div></div>\n` + reasoningHtml;
                                        chainOfThoughtContent.innerHTML = reasoningHtml;
                                        chainOfThoughtContent.style.display = 'block';
                                        chainOfThoughtPlaceholder.style.display = 'none';
                                    } else if (data.type === 'image_description') {
                                        // Add image description to reasoning panel
                                        reasoningHtml = `<div class='cot-image-description'><div class='cot-image-description-header'>🖼️ Image-to-Text Output</div><div class='cot-image-description-content'>${data.content}</div></div>\n` + reasoningHtml;
                                        chainOfThoughtContent.innerHTML = reasoningHtml;
                                        chainOfThoughtContent.style.display = 'block';
                                        chainOfThoughtPlaceholder.style.display = 'none';
                                    } else if (data.type === 'reasoning') {
                                        // Add reasoning to panel
                                        reasoningHtml += formatStreamingReasoning(data);
                                        chainOfThoughtContent.innerHTML = reasoningHtml;
                                        chainOfThoughtContent.style.display = 'block';
                                        chainOfThoughtPlaceholder.style.display = 'none';
                                    } else if (data.type === 'response_delta') {
                                        // Accumulate text and render markdown
                                        accumulatedText += data.delta;
                                        responseContent.innerHTML = marked.parse(accumulatedText);
                                        response.className = 'response';
                                        response.style.display = 'block';
                                    } else if (data.type === 'done') {
                                        // Streaming complete
                                        console.log('[STREAM] Received done signal');
                                        break;
                                    } else if (data.type === 'error') {
                                        // Error occurred
                                        console.error('[STREAM] Error from server:', data.message);
                                        responseContent.textContent = 'Error: ' + data.message;
                                        response.className = 'response error';
                                        response.style.display = 'block';
                                    }
                                } catch (parseError) {
                                    console.error('[STREAM] Error parsing JSON:', parseError, 'Line:', line);
                                }
                            }
                        }
                    }
                }
                
            } catch (error) {
                console.error('[STREAM] Error:', error);
                responseContent.innerHTML = 'Error: ' + error.message;
                response.className = 'response error';
                response.style.display = 'block';
            } finally {
                if (isImageQuery) {
                    analyzeBtn.disabled = false;
                    analyzeBtn.textContent = 'Get Content Placement Recommendation';
                } else {
                    submitBtn.disabled = false;
                }
                loading.style.display = 'none';
            }
        }
        
        async function checkHealth() {
            const healthDiv = document.getElementById('healthStatus');
            const healthBtn = document.getElementById('healthCheckBtn');
            
            // Update button and hide status div initially
            healthBtn.disabled = true;
            healthBtn.textContent = 'Checking...';
            healthDiv.style.display = 'none';
            
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                // Show status div with result
                healthDiv.style.display = 'block';
                
                if (data.status === 'healthy') {
                    healthDiv.innerHTML = '<strong>✅ Connected to Agent</strong><br><small>Endpoint: ' + (data.endpoint || 'Unknown') + '</small>';
                    healthDiv.className = 'health-status';
                } else {
                    healthDiv.innerHTML = '<strong>❌ Connection Error</strong><br>' + data.error;
                    healthDiv.className = 'health-status unhealthy';
                }
            } catch (error) {
                // Show status div with error
                healthDiv.style.display = 'block';
                healthDiv.innerHTML = '<strong>❌ Connection Error</strong><br>Unable to reach the server';
                healthDiv.className = 'health-status unhealthy';
            } finally {
                // Re-enable button
                healthBtn.disabled = false;
                healthBtn.textContent = 'Check Connection Status';
            }
        }
        
        document.getElementById('queryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const prompt = document.getElementById('prompt').value;
            
            // Use streaming function
            await handleStreamingQuery(prompt, false);
        });

        // Handle image analysis
        document.getElementById('analyzeImageBtn').addEventListener('click', async () => {
            const imagePreview = document.getElementById('imagePreview');
            const fileInput = document.getElementById('imageFile');
            
            if (!imagePreview.src || imagePreview.src === '') {
                alert('Please upload an image first');
                return;
            }
            
            try {
                // Get the file from the input
                const file = fileInput.files[0];
                if (!file) {
                    throw new Error('No image file found');
                }
                
                // Convert file to base64
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64String = reader.result.split(',')[1]; // Remove data:image/jpeg;base64, prefix
                        resolve(base64String);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                
                // Use streaming function
                await handleStreamingQuery(base64, true);
                
            } catch (error) {
                const response = document.getElementById('response');
                const responseContent = document.getElementById('responseContent');
                responseContent.innerHTML = 'Error: ' + error.message;
                response.className = 'response error';
                response.style.display = 'block';
                
                const analyzeBtn = document.getElementById('analyzeImageBtn');
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Get Content Placement Recommendation';
            }
        });
    </script>
</body>
</html> 